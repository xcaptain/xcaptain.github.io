{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/how-to-use-superset","webpackCompilationHash":"f6f4562cce5c2ca1e160","result":{"data":{"site":{"siteMetadata":{"author":{"name":"Joey Xie","contacts":{"twitter":"xf_joey"}},"disqusShortname":"joeyxf-com","subtitle":"每天进步一点点","title":"Joey的博客","url":"https://joeyxf.com"}},"markdownRemark":{"id":"387d1e3b-3fea-5c5f-be3b-3236cb374491","html":"<p>在选型的时候还考虑过redash，这个软件也很强大，但是似乎是个人项目，只有一个核心开发者，而superset是airbnb孵化的，apache基金会运营的，所以研发实力还是信得过的，应该会持续提供维护。简单看了一下superset的代码，前端是用react开发的，后端使用flask开发，整体架构还是比较简单清晰的</p>\n<h2 id=\"快速部署\"><a href=\"#%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2\" aria-label=\"快速部署 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>快速部署</h2>\n<p>看快速部署上线解决客户的问题最简单的办法就是使用docker镜像，官方的docker太简陋了，缺少很多数据源驱动，本地元数据存储也需在自己配置，使用起来不方便，我使用的是<a href=\"https://github.com/amancevice/docker-superset\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/amancevice/docker-superset</a>重新打包的镜像，做了很多自定义设置，使用起来很方便</p>\n<p>使用很简单，这个项目就是个docker-compose的配置，包含了如何本地构建superset镜像（默认配置，默认数据源驱动等），设置缓存和元数据数据库，我的数据是是<code class=\"language-text\">SQL Server</code>，选择的本地存储数据库是<code class=\"language-text\">PostgreSQL</code>，缓存当然是<code class=\"language-text\">Redis</code>，很快就跑起来了</p>\n<h2 id=\"快速上手\"><a href=\"#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B\" aria-label=\"快速上手 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>快速上手</h2>\n<p>按照上述步骤部署完成后会得到一个管理员账号，浏览器访问superset后台，输入帐号密码进入，看到的界面如下：\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c4822e5402f40ad1db1aebf8cf7edba3/51c08/superset-overview.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.58793969849247%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAvUlEQVQoz5WQOQ7CMBBFc/9LpcoV0kGRBpqQgLeZ8caXLaOwBMQrLPnnP9uZblkWa61zzhijtDZlo5SqYfhKhwZ6MLGu6nZZ16tShpwjYmbCSp9BvzMNHKCJFmZJKW9I2JYEV3nvUwN+k7W2Im4cpe/zMKR5Rj3FCM0hZ4Ys3qNYzYj8SSa6nU/6eMjTlKyt8qNaEZHYws3N5dkqBJtzLE99B9quDFiEgw8xph3i5tOrjMnvzfbHtMuP/wH6d3s/C5JvuNMBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/c4822e5402f40ad1db1aebf8cf7edba3/01472/superset-overview.webp 240w,\n/static/c4822e5402f40ad1db1aebf8cf7edba3/222bd/superset-overview.webp 480w,\n/static/c4822e5402f40ad1db1aebf8cf7edba3/620b9/superset-overview.webp 960w,\n/static/c4822e5402f40ad1db1aebf8cf7edba3/28063/superset-overview.webp 1440w,\n/static/c4822e5402f40ad1db1aebf8cf7edba3/240a7/superset-overview.webp 1592w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/c4822e5402f40ad1db1aebf8cf7edba3/0783d/superset-overview.png 240w,\n/static/c4822e5402f40ad1db1aebf8cf7edba3/782f4/superset-overview.png 480w,\n/static/c4822e5402f40ad1db1aebf8cf7edba3/f570d/superset-overview.png 960w,\n/static/c4822e5402f40ad1db1aebf8cf7edba3/8d0ff/superset-overview.png 1440w,\n/static/c4822e5402f40ad1db1aebf8cf7edba3/51c08/superset-overview.png 1592w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/c4822e5402f40ad1db1aebf8cf7edba3/f570d/superset-overview.png\"\n          alt=\"superset-overview\"\n          title=\"superset-overview\"\n          loading=\"lazy\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>和大部分BI系统一样，一个是控制面板列表，一个是报表列表，要做的事就是</p>\n<ol>\n<li>写SQL</li>\n<li>创建报表</li>\n<li>把报表添加到控制面板，并设置访问权限</li>\n</ol>\n<p>superset内置了一个很强大的<code class=\"language-text\">SQL Lab</code>，在这里可以调试自己的sql，当然大部分人都是在本地用编辑器是sql然后放到sql lab运行。在sql lab测试没问的的sql可以把查询结果视为一个数据源（datasource），sql lab支持把这个数据源创建为报表（chart）</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ea7b17b634c45c02024bbc123ebd1ec1/de6c6/sqllab-result.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.78489116517286%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAp0lEQVQY032PUQ6DIAxAvf9FdiGTmWWJzv1Ml1CgpSBCHXMz+9G9kKah7StUCgAdETuLaAlLQsyO2YegEEOMkg+pyHv0DOwMO80MhAPAU2ulFBhN7h8VEcYpLiLl5JzIWmdM13V1XZdYOuiYMvy2z/OcRVJKg1KX4XHr++bctG0LALbojjYvG7LGO9rTtSmP57U8jmOxi+x//De8OSSF4KYgX9vnbp8XHb5Z7l3bucoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/ea7b17b634c45c02024bbc123ebd1ec1/01472/sqllab-result.webp 240w,\n/static/ea7b17b634c45c02024bbc123ebd1ec1/222bd/sqllab-result.webp 480w,\n/static/ea7b17b634c45c02024bbc123ebd1ec1/620b9/sqllab-result.webp 960w,\n/static/ea7b17b634c45c02024bbc123ebd1ec1/28063/sqllab-result.webp 1440w,\n/static/ea7b17b634c45c02024bbc123ebd1ec1/975d2/sqllab-result.webp 1562w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/ea7b17b634c45c02024bbc123ebd1ec1/0783d/sqllab-result.png 240w,\n/static/ea7b17b634c45c02024bbc123ebd1ec1/782f4/sqllab-result.png 480w,\n/static/ea7b17b634c45c02024bbc123ebd1ec1/f570d/sqllab-result.png 960w,\n/static/ea7b17b634c45c02024bbc123ebd1ec1/8d0ff/sqllab-result.png 1440w,\n/static/ea7b17b634c45c02024bbc123ebd1ec1/de6c6/sqllab-result.png 1562w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/ea7b17b634c45c02024bbc123ebd1ec1/f570d/sqllab-result.png\"\n          alt=\"sqllab-result\"\n          title=\"sqllab-result\"\n          loading=\"lazy\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>点这里的explore就能把数据结果创建为报表</p>\n<p>接下来对报表的操作都很显然，界面设计的很直观，看一眼基本就知道怎么用，不知道的地方查看一下官方文档就行了。这里要注意一点，在是sql的时候我们喜欢使用别名，比如说<code class=\"language-text\">select name as 姓名</code>类似这样的写法，为了方便阅读结果，但是目前superset只支持别名是ascii字符，如果要导出普通人可读的报表（字段名都是中文）那该怎么办呢？</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/53396e3da8934fc25b76518b58bef756/005f0/edit-datasource.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.958791208791204%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAB8ElEQVQoz1VSTW/aQBDl91atRB1TFpsaLNSiGE6hB5BScWjVW8CUf1ECOQASh6pVmiZpaEmxY+z9tPvM0q8nezSW9817szMF0zRJmdi2Xa1WEQkhjUZjMpl8mEzOp+dILmaz2XR6MZ0in8/ny+VysVisVqtOp1MglkVsy7JtzQe52WxyJXma3tFEZhlNVSR4JEWaHaCUQuz3+wXQSCXHc8BxKrbtHR8nlIZBIJX6cn17u/6eMBZRuotjytjDbsc4F0rlykXDePT4iXFkFo9M0zDsMmm32/idJImScv1js90G0JFSCrwKUaAoyK9ALhMC8Xq9XqvV3FrNqVbbnhes10EYgs85Z4zFcZz8A0oTlOucdAro03EcTUZiWVbL88L7+81mEwQBxcH89F/ozzRNc9ulZ+XiUwM010WFOmrBdhRFYYiuA8Zywn+6exeZJpdJxSyVtLjruri1VquFngGl5M9tED5ESLiGEGwfD8r7Oz7Y1sqaDGU09uny6uZujYRLyfdXxYTAzWFsvV4v71m3rUtockwpehacf/x8+fXmG0xiWniY4DGjIGPQ3W63oBdL60Mcued5GIreh3yynP/ejkzvyXUSiyx7fXqa2/4D7QLrORqNxuPxcDgc5fAHg4HvD/093vv+yds3787Omi9e/gIyZCKuXy0HWwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/53396e3da8934fc25b76518b58bef756/01472/edit-datasource.webp 240w,\n/static/53396e3da8934fc25b76518b58bef756/222bd/edit-datasource.webp 480w,\n/static/53396e3da8934fc25b76518b58bef756/620b9/edit-datasource.webp 960w,\n/static/53396e3da8934fc25b76518b58bef756/28063/edit-datasource.webp 1440w,\n/static/53396e3da8934fc25b76518b58bef756/a7aba/edit-datasource.webp 1456w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/53396e3da8934fc25b76518b58bef756/0783d/edit-datasource.png 240w,\n/static/53396e3da8934fc25b76518b58bef756/782f4/edit-datasource.png 480w,\n/static/53396e3da8934fc25b76518b58bef756/f570d/edit-datasource.png 960w,\n/static/53396e3da8934fc25b76518b58bef756/8d0ff/edit-datasource.png 1440w,\n/static/53396e3da8934fc25b76518b58bef756/005f0/edit-datasource.png 1456w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/53396e3da8934fc25b76518b58bef756/f570d/edit-datasource.png\"\n          alt=\"edit-datasource\"\n          title=\"edit-datasource\"\n          loading=\"lazy\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>在这里给每个列添加一个别名就行了，然后刷新结果就能看到对应的中文字段</p>\n<h2 id=\"权限控制\"><a href=\"#%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6\" aria-label=\"权限控制 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>权限控制</h2>\n<p>对于一个BI系统来说，权限控制当然很重要，不然谁都能看核心数据就乱套了。核心也就是RBAC，先创建一个帐号，再创建一个角色，把角色赋予这个帐号，然后把每个报表（数据源）的权限赋的对应角色就行了</p>\n<h2 id=\"调试\"><a href=\"#%E8%B0%83%E8%AF%95\" aria-label=\"调试 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>调试</h2>\n<p>因为superset后端代码是用flask框架写的，所以改起来还算方便，我最近遇到个问题需要在导出csv文件的时候让表头变为中文，也就是使用上面设置的列名别名，分享下我修改源码的经历</p>\n<p>首先要在本地跑起superset来，按照官方的文档做就行，简单说就是：</p>\n<ol>\n<li>\n<p>创建virtual environment</p>\n<p><code class=\"language-text\">python3 -m venv venv</code></p>\n</li>\n<li>\n<p>激活当前虚拟环境</p>\n<p><code class=\"language-text\">. venv/bin/activate.fish</code></p>\n</li>\n<li>\n<p>安装依赖</p>\n<p><code class=\"language-text\">pip install -r requirements.txt; pip install -r requirements-dev.txt</code></p>\n</li>\n<li>\n<p>构建superset</p>\n<p><code class=\"language-text\">pip install -e .</code></p>\n</li>\n<li>\n<p>运行superset</p>\n<p><code class=\"language-text\">superset run -p 8088 --with-threads --reload --debugger -h 0.0.0.0</code></p>\n</li>\n</ol>\n<p>光跑起来还不够，想要知道系统内部是怎么运行的还需要配置好调试器，然后单步执行才能理解系统如何处理每个请求的，因为是flask app，我用的编辑器vscode的支持比较好，microsoft对python有官方支持，对flask 也有官方支持，所以在添加调试配置的时候选择flask app，就行，最后编辑<code class=\"language-text\">launch.json</code>把<code class=\"language-text\">flask_app</code>设置为<code class=\"language-text\">superset</code>就行，然后按下<kbd>F5</kbd>就能以调试模式运行superset了，接下来的套路就很简单，设置端点，单步执行，检查变量值。如果没有调试器的话对这么大型的项目要一步一步print查看变量值，简直没法执行。</p>\n<p>最后我给官方提的补丁见<a href=\"https://github.com/apache/incubator-superset/pull/7795\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/apache/incubator-superset/pull/7795</a>，很简单很清晰的改动，但还没有被合并进去。为了让我自己的服务器体验最新的补丁，我直写修改了docker容器里的代码，非常机智，这样就不用等上游合并了</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker <span class=\"token builtin class-name\">exec</span> -it -u <span class=\"token number\">0</span> container_id /bin/bash <span class=\"token comment\"># 以root身份执行shell</span>\ndocker <span class=\"token function\">cp</span> 5ede569d1a0a:/usr/local/lib/python3.6/site-packages/superset/viz.py <span class=\"token builtin class-name\">.</span>\ndocker <span class=\"token function\">cp</span> 5ede569d1a0a:/etc/superset/superset-config.py <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>把这2个文件从容器中复制出来，修改完再复制回去，然后重启docker容器就行，啥不会重启？执行<code class=\"language-text\">docker-compose restart</code>搞定</p>","fields":{"slug":"/posts/how-to-use-superset","tagSlugs":["/tag/python/","/tag/web/"]},"frontmatter":{"date":"2019-07-01 00:01","description":"superset是一个强大的数据可视化软件，可以很方便的创建报表，并且支持多维度查询，最近在项目中直接使用到了superset，并且还对它进行了二次开发，以下将总结下使用心得","tags":["Python","Web"],"title":"使用与调试superset"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/posts/how-to-use-superset"}}}